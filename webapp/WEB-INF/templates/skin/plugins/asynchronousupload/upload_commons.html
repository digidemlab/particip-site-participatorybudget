<#--
 # The main macro is addFileInputAndfilesBox. The macro addRequiredJsFiles is used to include required JavaScript and CSS files.
 # Others macros are private.
 # Add required CSS and JavaScript files to use asynchronous uploads.
 # This is only needed in Back Office or in FO page not served by the portal service.
 -->

<#macro addRequiredJsFiles>
    <link rel="stylesheet" href="css/plugins/asynchronousupload/jquery.fileupload.css" />
    <link rel="stylesheet" href="css/plugins/asynchronousupload/jquery.fileupload-ui.css" />
    <script type="text/javascript" src="js/plugins/asynchronousupload/load-image.min.js" ></script>
    <script type="text/javascript" src="js/plugins/asynchronousupload/vendor/jquery.ui.widget.js" ></script>
    <script type="text/javascript" src="js/plugins/asynchronousupload/jquery.iframe-transport.js" ></script>
    <script type="text/javascript" src="js/plugins/asynchronousupload/jquery.fileupload.js" ></script>
    <script type="text/javascript" src="js/plugins/asynchronousupload/jquery.fileupload-process.js" ></script>
    <script type="text/javascript" src="js/plugins/asynchronousupload/canvas-to-blob.min.js"></script>
    <script type="text/javascript" src="js/plugins/asynchronousupload/jquery.fileupload-image.js" ></script>
    <script type="text/javascript" src="js/plugins/asynchronousupload/jquery.fileupload-validate.js" ></script>
</#macro>

<#macro addFileInput fieldName handler cssClass multiple=false singleUpload=false>
    <span class="file-input btn-file">
        <input type="file" name="${fieldName}" id="${fieldName}" <#if multiple>multiple="multiple"</#if> class="${cssClass!} ${handler.handlerName}" />
        <button class="btn btn-default btn-upload" name="${handler.uploadSubmitPrefix}${fieldName}" id="${handler.uploadSubmitPrefix}${fieldName}" value="${handler.uploadSubmitPrefix}${fieldName}" type="submit" >
            <#if !singleUpload>
                Choisissez un ou des fichier(s)
             <#else>
                  Choisissez un fichier
             </#if>     
        </button>
    </span>
    <input type="hidden" name="asynchronousupload.handler" value="${handler.handlerName}" />
    <div id="progress_${fieldName}" class="progress" style="display:none;">
    <div id="progress-bar_${fieldName}" class="progress-bar progress-bar-success progress-bar-striped">&nbsp;</div>
  </div>
</#macro>

<#macro addFileInputImage fieldName handler cssClass multiple=false singleUpload=false>
    <span class="file-input btn-file">
        <input type="file" name="${fieldName}" id="${fieldName}" <#if multiple>multiple="multiple"</#if> class="${cssClass!} ${handler.handlerName}${fieldName}" />
        <button class="btn btn-default btn-upload" name="${handler.uploadSubmitPrefix}${fieldName}" id="${handler.uploadSubmitPrefix}${fieldName}" value="${handler.uploadSubmitPrefix}${fieldName}" type="submit" >
              <#if !singleUpload>
                Choisissez un ou des fichier(s)
             <#else>
                  Choisissez un fichier
             </#if> 
        </button>
    </span>
    <input type="hidden" name="asynchronousupload.handler" value="${handler.handlerName}" />
    <div id="progress_${fieldName}" class="progress" style="display: none;">
    <div id="progress-bar_${fieldName}" class="progress-bar progress-bar-success progress-bar-striped">&nbsp;</div>
  </div>
</#macro>

<#macro addUploadedFilesBox fieldName handler listFiles >
    <#-- file removing -->
    <#assign has_files = false>
    <#if listFiles?? && listFiles?has_content>
        <#assign has_files = true>
    </#if>
  <#if has_files>
    <div class="form-group upload-header">
      <p class="form-control-static">#i18n{asynchronousupload.file.uploadedFile} <br><small>Cliquez sur une case pour supprimer un document</small></p>
    </div>
    
  </#if>
    <div id="_file_error_box_${fieldName}"></div>
    <div class="form-group" <#if !has_files>style="display:none;"</#if> id="_file_deletion_label_${fieldName}">
    <div id="_file_deletion_${fieldName}">
        <#assign file_index = 0>
        <#if has_files>
            <#assign index = 0 />
            <#list listFiles as file>
                <#assign filename = ''>
                <#if file.name?? && file.name != ''>
                    <#assign filename = file.name >
                <#else>
                    <#if file.title?? && file.title != ''>
                        <#assign filename = file.title >
                    </#if>
                </#if>
                <#if filename != '' >
                    <label class="checkbox-inline" for="${handler.uploadCheckboxPrefix}${fieldName}${file_index}" id="_file_uploaded_${fieldName}${file_index}">
                      <input type="checkbox" name="${handler.uploadCheckboxPrefix}${fieldName}${file_index}" value="1">
              ${filename}
            </label>
            <#assign file_index = file_index + 1>
                </#if>
            </#list>
        </#if>
    </div>
  </div>
  <div class="form-group">
    <button class="btn btn-xs text-success" name="${handler.uploadDeletePrefix}${fieldName}" value="${handler.uploadDeletePrefix}${fieldName}" type="submit" >
      <i class="fa fa-trash"></i> #i18n{asynchronousupload.action.delete.name}
    </button>
    </div>
  <#if has_files>
    <div class="form-group">
      <label class="checkbox-inline">
        <input name="accept_exploit" value ="true" type="checkbox" <#if form_etape_upload.acceptExploit??&&form_etape_upload.acceptExploit=="true">checked="checked"</#if>>#dskey{ideation.site_property.form.image_exploit_label_text}
      </label>
    </div>
  </#if>
</#macro>

<#-- Macro to add a file input for asynchronous and synchronous uploads.
 # @param fieldName The name of the field.
 # @param handler The associated handler service.
 # @param listUploadedFiles The list of files that have already been uploaded. Files must have a 'title' or a 'name' attribute.
 # @param inputCssClass The CSS class to add to the input if any. Default value is an empty string.
 # @param multiple True to use an HTML5 multiple file input, false otherwise. Default value if false.
 # @param singleUpload True  for limiting the number of upload at one file
 
 -->
<#macro addFileInputAndfilesBox fieldName handler listUploadedFiles inputCssClass='' multiple=false  singleUpload=false>
    <@addFileInput fieldName=fieldName handler=handler cssClass=inputCssClass multiple=multiple singleUpload=singleUpload />
    <@addUploadedFilesBox fieldName=fieldName handler=handler listFiles=listUploadedFiles />
</#macro>

<#-- Macro to add a file image input for asynchronous and synchronous uploads.
 # @param fieldName The name of the field.
 # @param handler The associated handler service.
 # @param listUploadedFiles The list of files that have already been uploaded. Files must have a 'title' or a 'name' attribute.
 # @param inputCssClass The CSS class to add to the input if any. Default value is an empty string.
 # @param multiple True to use an HTML5 multiple file input, false otherwise. Default value if false.
 #@param singleUpload True  for limiting the number of upload at one file. Default value if false.
 -->

<#macro addFileInputImageAndfilesBox fieldName handler listUploadedFiles inputCssClass='' multiple=false singleUpload=false>
    <@addFileInputImage fieldName=fieldName handler=handler cssClass=inputCssClass multiple=multiple singleUpload=singleUpload/>
    <@addUploadedFilesBox fieldName=fieldName handler=handler listFiles=listUploadedFiles />
</#macro>
